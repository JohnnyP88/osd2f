window.file_upload=(()=>{var e={319:function(e){async function t(e,n={raw:!1}){const s=e=>{if(t.didShowInfo)return;if("EncodingError"!==e.name)return;t.didShowInfo=!0;const n=`${e.name} occured within datatransfer-files-promise module\nError message: "${e.message}"\nTry serving html over http if currently you are running it from the filesystem.`;console.warn(n)},i=(e,t)=>new Promise(((n,i)=>{e.readEntries((async e=>{let s=[];for(let n of e){const e=await r(n,t);s=s.concat(e)}n(s)}),(e=>{s(e),i(e)}))})),r=async(e,t="")=>e.isFile?[await((e,t="")=>new Promise(((i,r)=>{e.file((e=>{n.raw||(e.filepath=t+e.name),i(e)}),(e=>{s(e),r(e)}))})))(e,t)]:e.isDirectory?await(async(e,t)=>{const n=e.createReader(),s=t+e.name+"/";let r,o=[];do{r=await i(n,s),o=o.concat(r)}while(r.length>0);return o})(e,t):void 0;let o=[],a=[];for(let t=0,n=e.length;t<n;t++)a.push(e[t].webkitGetAsEntry());for(let e of a){const t=await r(e);o=o.concat(t)}return o}this.window&&this===this.window?this.getFilesFromDataTransferItems=t:e.exports.getFilesFromDataTransferItems=t},956:(e,t,n)=>{"use strict";n.r(t),n.d(t,{fileLoadController:()=>u,fileSelectHandler:()=>h});class s{constructor(e,t,n,s){this._name=e,this._size=t,this._path=n,this._archiveRef=s}get name(){return this._name}get size(){return this._size}extract(){return this._archiveRef.extractSingleFile(this._path)}}class i{static init(e={}){return i._options={workerUrl:"../dist/worker-bundle.js",...e},i._options}static open(e,t=null){return t=t||i._options||i.init()&&console.warn("Automatically initializing using options: ",i._options),new i(e,t).open()}constructor(e,t){this._worker=new Worker(t.workerUrl),this._worker.addEventListener("message",this._workerMsg.bind(this)),this._callbacks=[],this._content={},this._processed=0,this._file=e}async open(){return await this._postMessage({type:"HELLO"},((e,t,n)=>{"READY"===n.type&&e()})),await this._postMessage({type:"OPEN",file:this._file},((e,t,n)=>{"OPENED"===n.type&&e(this)}))}hasEncryptedData(){return this._postMessage({type:"CHECK_ENCRYPTION"},((e,t,n)=>{"ENCRYPTION_STATUS"===n.type&&e(n.status)}))}usePassword(e){return this._postMessage({type:"SET_PASSPHRASE",passphrase:e},((e,t,n)=>{"PASSPHRASE_STATUS"===n.type&&e(n.status)}))}getFilesObject(){return this._processed>0?Promise.resolve().then((()=>this._content)):this._postMessage({type:"LIST_FILES"},((e,t,n)=>{if("ENTRY"===n.type){const e=n.entry,[t,i]=this._getProp(this._content,e.path);return"FILE"===e.type&&(t[i]=new s(e.fileName,e.size,e.path,this)),!0}"END"===n.type&&(this._processed=1,e(this._cloneContent(this._content)))}))}getFilesArray(){return this.getFilesObject().then((e=>this._objectToArray(e)))}extractSingleFile(e){return this._postMessage({type:"EXTRACT_SINGLE_FILE",target:e},((e,t,n)=>{"FILE"===n.type&&e(new File([n.entry.fileData],n.entry.fileName,{type:"application/octet-stream"}))}))}extractFiles(e){return this._processed>1?Promise.resolve().then((()=>this._content)):this._postMessage({type:"EXTRACT_FILES"},((t,n,s)=>{if("ENTRY"===s.type){const[t,n]=this._getProp(this._content,s.entry.path);return"FILE"===s.entry.type&&(t[n]=new File([s.entry.fileData],s.entry.fileName,{type:"application/octet-stream"}),void 0!==e&&setTimeout(e.bind(null,{file:t[n],path:s.entry.path}))),!0}"END"===s.type&&(this._processed=2,this._worker.terminate(),t(this._cloneContent(this._content)))}))}_cloneContent(e){if(e instanceof File||e instanceof s||null===e)return e;const t={};for(const n of Object.keys(e))t[n]=this._cloneContent(e[n]);return t}_objectToArray(e,t=""){const n=[];for(const i of Object.keys(e))e[i]instanceof File||e[i]instanceof s||null===e[i]?n.push({file:e[i]||i,path:t}):n.push(...this._objectToArray(e[i],`${t}${i}/`));return n}_getProp(e,t){const n=t.split("/");""===n[n.length-1]&&n.pop();let s=e,i=null;for(const e of n)s[e]=s[e]||{},i=s,s=s[e];return[i,n[n.length-1]]}_postMessage(e,t){return this._worker.postMessage(e),new Promise(((e,n)=>{this._callbacks.push(this._msgHandler.bind(this,t,e,n))}))}_msgHandler(e,t,n,s){if("BUSY"===s.type)n("worker is busy");else{if("ERROR"!==s.type)return e(t,n,s);n(s.error)}}_workerMsg({data:e}){(0,this._callbacks[this._callbacks.length-1])(e)||this._callbacks.pop()}}var r=new Array;class o{SetData(e){r.push(...e)}ClearData(){r=new Array}GetRaw(){return console.log(r),JSON.stringify(r)}GetObj(){return null}}async function a(e){return(e=await fetch("/adv_anonymize_file",{method:"POST",mode:"same-origin",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((e=>e.json())).catch((e=>console.log(e.error)))).data}function l(e){document.getElementById("files").innerHTML+=`<p>${e.filename} : <b> ${e.entries.length} </b> datapoints</p>`}document.getElementById("donatebutton").addEventListener("click",(function(){document.getElementById("donatespinner").classList.remove("invisible"),document.getElementById("donatebutton").classList.add("disabled"),document.getElementById("donatebutton").setAttribute("disabled",!0),fetch("/upload",{method:"POST",mode:"same-origin",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:o.prototype.GetRaw()}).then((()=>{document.getElementById("donatespinner").classList.add("invisible"),document.getElementById("thankyou").classList.remove("invisible"),noDonationYet=!1})).catch((e=>{console.log("Error",e)}))}));var c=n(319);i.init({workerUrl:"/static/js/libarchive/worker-bundle.js"});const p=function(e,t,n){let s,i={},r=e.map((e=>e.split(".").shift(1)));for(s of Object.keys(t)){if(0==r.filter((e=>e==s)).length)continue;let o=[n,s].filter((e=>void 0!==e)).join("."),a=t[s],l=e.filter((e=>e.startsWith(s))).map((e=>e.substring(s.length+1,e.length)));Array.isArray(a)?i[o]=a.map((e=>p(l,e))):"object"!=typeof a||null==a?i[o]=a:i=Object.assign(i,p(l,a,s))}return i},d=function(e,t,n,s){return null!=s?d(e,t[s],n):Array.isArray(t)&&0==e.length?[{entries:t}]:t.map((t=>p(e,t)))},u=async function(e,t,n,s){var i;let r;document.getElementById("processing").classList.remove("invisible"),i=Object.fromEntries(n.map((e=>{let n;for(n of Object.keys(t.files))if(RegExp(n).exec(e.name))return[e.name,n];return[]}))),Object.keys(i).map((e=>{"undefined"===e&&delete i[e]})),r=n.filter((e=>void 0!==i[e.name]));let c,p=[],u=document.getElementById("progress-bar");for(c of(u.value=0,r)){let n,s,o;if(null!=c.text)n=await c.text();else{let e=await c.extract();n=await e.text()}s=new Object,s.filename=c.name,s.submission_id=e;try{s.entries=d(t.files[i[c.name]].accepted_fields,JSON.parse(n),null,t.files[i[c.name]].in_key),s=await a(s),p.push(s)}catch(e){console.log("Unable to parse file because it's not real JSON")}o=p.length/r.length*100,o!==u.value&&(u.value=o)}p=p.filter((e=>e)),o.prototype.SetData(p),u.value=100,document.getElementById("processing").classList.add("invisible"),document.getElementById("donatebutton").classList.remove("disabled");try{document.getElementById("donatebutton").attributes.removeNamedItem("disabled")}catch{}p.forEach(l)};async function h(e){var t=e.target.files;if(void 0!==t)if(null!=RegExp(".*.zip$").exec(t[0].name)){let e=await i.open(t[0]),n=(await e.getFilesArray()).map((e=>e.file));u(sid,settings,n)}else u(sid,settings,Array(t[0]));else console.log("no files",e)}document.getElementById("fileElem").onchange=h,document.getElementById("drop-area").addEventListener("drop",(async function(e){let t=await(0,c.getFilesFromDataTransferItems)(e.dataTransfer.items);if(1==t.length&&null!=RegExp(".*.zip$").exec(t[0].name)){let e=await i.open(t[0]),n=(await e.getFilesArray()).map((e=>e.file));u(sid,settings,n)}else u(sid,settings,t)}),!1)}},t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,n),i.exports}return n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n(956)})();